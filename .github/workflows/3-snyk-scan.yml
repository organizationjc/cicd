name: 3 - Snyk Scan

on:
  workflow_call:
    inputs:
      runs-on:
        type: string
        default: 'ubuntu-latest'
      build-system:
        type: string
        required: true            # maven | gradle
      java-version:
        type: string
        default: '17'
      severity-threshold:
        type: string
        default: 'high'
      use-docker-action:
        type: boolean
        default: true             # true = usa acción Docker de Snyk para Maven
      jdk-major:
        type: string
        default: '17'             # '11' o '17' (solo aplica a Maven con Docker)
      extra-args:
        type: string
        default: ''               # ej: --exclude=**/examples/** --org=mi-org
    secrets:
      SNYK_TOKEN:
        required: true

jobs:
  snyk:
    runs-on: ${{ inputs.runs-on }}
    steps:
      - uses: actions/checkout@v4

      # ─────────────────────────────────────────────────────────────
      # Ruta A (Maven + Docker): JDK 17
      # ─────────────────────────────────────────────────────────────
      - name: Snyk (Maven + Docker action JDK 17)
        if: ${{ inputs.use-docker-action && inputs.build-system == 'maven' && inputs.jdk-major == '17' }}
        uses: snyk/actions/maven-3-jdk-17@v3
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: test
          args: >-
            --severity-threshold=${{ inputs.severity-threshold }}
            --all-projects
            --print-deps
            ${{ inputs.extra-args }}

      # ─────────────────────────────────────────────────────────────
      # Ruta A (Maven + Docker): JDK 11
      # ─────────────────────────────────────────────────────────────
      - name: Snyk (Maven + Docker action JDK 11)
        if: ${{ inputs.use-docker-action && inputs.build-system == 'maven' && inputs.jdk-major == '11' }}
        uses: snyk/actions/maven-3-jdk-11@v3
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: test
          args: >-
            --severity-threshold=${{ inputs.severity-threshold }}
            --all-projects
            --print-deps
            ${{ inputs.extra-args }}

      # ─────────────────────────────────────────────────────────────
      # Ruta B (CLI nativa: Maven o Gradle) — evita Docker y usa el JDK del runner
      # ─────────────────────────────────────────────────────────────
      - name: Setup Java
        if: ${{ !inputs.use-docker-action }}
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ inputs.java-version }}
          cache: ${{ inputs.build-system }}

      - name: Snyk CLI setup
        if: ${{ !inputs.use-docker-action }}
        uses: snyk/actions/setup@v4

      - name: Snyk test (CLI)
        if: ${{ !inputs.use-docker-action }}
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          snyk test \
            --severity-threshold=${{ inputs.severity-threshold }} \
            --all-projects \
            --print-deps \
            ${{ inputs.extra-args }}
